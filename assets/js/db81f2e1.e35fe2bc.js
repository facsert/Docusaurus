"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[8750],{1430:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>r,contentTitle:()=>c,default:()=>u,frontMatter:()=>l,metadata:()=>o,toc:()=>i});var t=s(4848),d=s(8453);const l={author:"facsert",pubDatetime:new Date("2024-01-30T21:12:43.000Z"),title:"PromQl",slug:"PromQl",featured:!1,draft:!1,tags:["Prometheus"],description:"PromQl \u662f prometheus \u7528\u5177\u6570\u636e\u7b5b\u9009\u7684\u8bed\u8a00"},c=void 0,o={id:"Prometheus/promQL",title:"PromQl",description:"PromQl \u662f prometheus \u7528\u5177\u6570\u636e\u7b5b\u9009\u7684\u8bed\u8a00",source:"@site/docs/Prometheus/promQL.md",sourceDirName:"Prometheus",slug:"/Prometheus/PromQl",permalink:"/docs/Prometheus/PromQl",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Prometheus/promQL.md",tags:[{inline:!0,label:"Prometheus",permalink:"/docs/tags/prometheus"}],version:"current",frontMatter:{author:"facsert",pubDatetime:"2024-01-30T21:12:43.000Z",title:"PromQl",slug:"PromQl",featured:!1,draft:!1,tags:["Prometheus"],description:"PromQl \u662f prometheus \u7528\u5177\u6570\u636e\u7b5b\u9009\u7684\u8bed\u8a00"},sidebar:"tutorialSidebar",previous:{title:"Grafana",permalink:"/docs/Prometheus/Grafana"},next:{title:"Python APScheduler",permalink:"/docs/Python/Python APScheduler"}},r={},i=[{value:"Table of Contents",id:"table-of-contents",level:2},{value:"\u4ecb\u7ecd",id:"\u4ecb\u7ecd",level:2},{value:"metrics \u6570\u636e\u7c7b\u578b",id:"metrics-\u6570\u636e\u7c7b\u578b",level:2},{value:"Counter",id:"counter",level:3},{value:"Gauge",id:"gauge",level:3},{value:"Histogram",id:"histogram",level:3},{value:"Summary",id:"summary",level:3},{value:"\u5339\u914d\u6570\u636e",id:"\u5339\u914d\u6570\u636e",level:2},{value:"\u5339\u914d",id:"\u5339\u914d",level:2},{value:"\u8303\u56f4\u67e5\u8be2",id:"\u8303\u56f4\u67e5\u8be2",level:2},{value:"\u805a\u5408\u64cd\u4f5c",id:"\u805a\u5408\u64cd\u4f5c",level:2},{value:"\u6570\u5b66\u8fd0\u7b97",id:"\u6570\u5b66\u8fd0\u7b97",level:2},{value:"\u5185\u7f6e\u51fd\u6570",id:"\u5185\u7f6e\u51fd\u6570",level:2},{value:"increase",id:"increase",level:3},{value:"rate",id:"rate",level:3},{value:"irate",id:"irate",level:3},{value:"\u793a\u4f8b",id:"\u793a\u4f8b",level:2},{value:"\u8282\u70b9\u8fde\u63a5",id:"\u8282\u70b9\u8fde\u63a5",level:3},{value:"CPU \u5360\u7528\u7387",id:"cpu-\u5360\u7528\u7387",level:3},{value:"\u5185\u5b58\u5360\u7528",id:"\u5185\u5b58\u5360\u7528",level:3},{value:"\u786c\u76d8\u5360\u7528",id:"\u786c\u76d8\u5360\u7528",level:3},{value:"API",id:"api",level:2}];function a(e){const n={a:"a",br:"br",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,d.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h2,{id:"table-of-contents",children:"Table of Contents"}),"\n",(0,t.jsx)(n.h2,{id:"\u4ecb\u7ecd",children:"\u4ecb\u7ecd"}),"\n",(0,t.jsxs)(n.p,{children:["PromQL \u662f prometheus \u5185\u7f6e\u7684\u6570\u636e\u67e5\u8be2\u8bed\u8a00, \u4f7f\u7528 PromQL \u5bf9 prometheus \u6536\u96c6\u7684\u6570\u636e\u8fdb\u884c\u7b5b\u9009\u8ba1\u7b97\u7b49",(0,t.jsx)(n.br,{}),"\n","prometheus \u6570\u636e\u683c\u5f0f: ",(0,t.jsx)(n.code,{children:"data_name{label0=value, label1=value, label2=value} data_value"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Node exporter \u6536\u96c6\u7684 metrics \u6570\u636e\u793a\u4f8b\n\n# HELP node_cpu_seconds_total Seconds the CPUs spent in each mode.\n# TYPE node_cpu_seconds_total counter\nnode_cpu_seconds_total{cpu="0",mode="idle"} 24226.24\nnode_cpu_seconds_total{cpu="0",mode="iowait"} 0.96\nnode_cpu_seconds_total{cpu="0",mode="irq"} 0\nnode_cpu_seconds_total{cpu="0",mode="nice"} 0\n\n# HELP node_memory_MemFree_bytes Memory information field MemFree_bytes.\n# TYPE node_memory_MemFree_bytes gauge\nnode_memory_MemFree_bytes 9.904422912e+09\n\n# HELP node_memory_Active_bytes Memory information field Active_bytes.\n# TYPE node_memory_Active_bytes gauge\nnode_memory_Active_bytes 4.65158144e+08\n'})}),"\n",(0,t.jsxs)(n.p,{children:["\u4f7f\u7528 ",(0,t.jsx)(n.code,{children:"data_name{label0=value, label1=value,}"})," \u7b5b\u9009\u6570\u636e"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# \u663e\u793a\u6240\u6709\u7684 node_cpu_seconds_total \u6570\u636e\u4e2d cpu="0" \u7684\u6570\u636e(\u4e0d\u540c\u8282\u70b9\u7684\u4fe1\u606f\u4f1a\u9644\u5e26 instance \u548c job)\nnode_cpu_seconds_total{cpu="0"}\n> node_cpu_seconds_total{cpu="0", instance="10.143.232.175:9100", job="V2-Node", mode="idle"}    26274.44\n> ......\n> node_cpu_seconds_total{cpu="0", instance="10.39.104.158:9100", job="V2-Node", mode="system"}   392.63\n> ......\n> node_cpu_seconds_total{cpu="0", instance="10.39.104.18:9100", job="V2-Node", mode="steal"}     0\n'})}),"\n",(0,t.jsx)(n.h2,{id:"metrics-\u6570\u636e\u7c7b\u578b",children:"metrics \u6570\u636e\u7c7b\u578b"}),"\n",(0,t.jsxs)(n.p,{children:["Prometheus \u7684 metrics \u6570\u636e\u6709\u591a\u79cd\u7c7b\u578b, \u6570\u636e\u6ce8\u91ca\u7ed3\u5c3e\u4e2d\u4f1a\u8868\u660e\u6570\u636e\u7c7b\u578b",(0,t.jsx)(n.br,{}),"\n","prometheus \u7684\u6570\u636e\u672c\u8d28\u662f /proc \u4e0b\u6587\u4ef6\u5185\u5bb9, /proc \u8bb0\u5f55\u7740\u8282\u70b9, \u8fdb\u7a0b \u7b49\u7684\u5b9e\u65f6\u6570\u636e",(0,t.jsx)(n.br,{}),"\n","ex: ",(0,t.jsx)(n.code,{children:"/proc/stat (cpu \u5b9e\u65f6\u6570\u636e)  /proc/meminfo (\u5185\u5b58\u5b9e\u65f6\u6570\u636e)  /proc/<pid> (\u8fdb\u7a0b\u5b9e\u65f6\u6570\u636e)"})]}),"\n",(0,t.jsx)(n.h3,{id:"counter",children:"Counter"}),"\n",(0,t.jsx)(n.p,{children:"\u8ba1\u6570\u5668\u7c7b\u578b, \u6570\u503c\u53ea\u589e\u52a0(\u9664\u975e\u7cfb\u7edf\u91cd\u7f6e), \u5982 node_cpu_seconds_total \u8282\u70b9 cpu \u6267\u884c\u65f6\u95f4"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# HELP node_cpu_seconds_total Seconds the CPUs spent in each mode.\n# TYPE node_cpu_seconds_total counter\nnode_cpu_seconds_total{cpu="0",mode="idle"} 31712.24\nnode_cpu_seconds_total{cpu="0",mode="iowait"} 0.96\nnode_cpu_seconds_total{cpu="0",mode="irq"} 0\nnode_cpu_seconds_total{cpu="0",mode="nice"} 0\nnode_cpu_seconds_total{cpu="0",mode="softirq"} 119.36\nnode_cpu_seconds_total{cpu="0",mode="steal"} 0\nnode_cpu_seconds_total{cpu="0",mode="system"} 617.85\nnode_cpu_seconds_total{cpu="0",mode="user"} 1529.83\n'})}),"\n",(0,t.jsx)(n.h3,{id:"gauge",children:"Gauge"}),"\n",(0,t.jsx)(n.p,{children:"\u53ef\u589e\u51cf\u7684\u4eea\u8868\u76d8, \u6570\u503c\u53ef\u589e\u53ef\u51cf, \u7528\u4e8e\u8868\u793a\u5f53\u524d\u72b6\u6001, node_memory_MemFree_bytes \u5f53\u524d\u7a7a\u95f2\u5185\u5b58"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# HELP node_memory_MemFree_bytes Memory information field MemFree_bytes.\n# TYPE node_memory_MemFree_bytes gauge\nnode_memory_MemFree_bytes 9.904422912e+09\n# HELP node_memory_MemTotal_bytes Memory information field MemTotal_bytes.\n# TYPE node_memory_MemTotal_bytes gauge\nnode_memory_MemTotal_bytes 2.4360300544e+10\n# HELP node_memory_Mlocked_bytes Memory information field Mlocked_bytes.\n# TYPE node_memory_Mlocked_bytes gauge\nnode_memory_Mlocked_bytes 0\n"})}),"\n",(0,t.jsx)(n.h3,{id:"histogram",children:"Histogram"}),"\n",(0,t.jsx)(n.p,{children:"\u76f4\u65b9\u56fe, \u8868\u793a\u4e00\u7ec4\u89c2\u6d4b\u503c\u7684\u5206\u5e03, \u901a\u5e38\u7528\u4e8e\u5ea6\u91cf\u8bf7\u6c42\u6301\u7eed\u65f6\u95f4\u7b49"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# HELP http_request_duration_seconds HTTP request duration in seconds\n# TYPE http_request_duration_seconds histogram\nhttp_request_duration_seconds_bucket{le="0.1"} 10\nhttp_request_duration_seconds_bucket{le="1"} 20\nhttp_request_duration_seconds_bucket{le="5"} 30\nhttp_request_duration_seconds_bucket{le="10"} 40\nhttp_request_duration_seconds_bucket{le="+Inf"} 50\nhttp_request_duration_seconds_sum 235.5\nhttp_request_duration_seconds_count 50\n'})}),"\n",(0,t.jsxs)(n.p,{children:["\u64cd\u4f5c\u6b21\u6570 50, \u8017\u65f6 235.5s",(0,t.jsx)(n.br,{}),"\n","\u8017\u65f6 \u5c0f\u4e8e 0.1s \u7684\u6709 10\u6b21",(0,t.jsx)(n.br,{}),"\n","\u8017\u65f6 \u5c0f\u4e8e 1s \u7684\u6709 20\u6b21",(0,t.jsx)(n.br,{}),"\n","\u8017\u65f6 \u5c0f\u4e8e 5s \u7684\u6709 30\u6b21",(0,t.jsx)(n.br,{}),"\n","\u8017\u65f6 \u5c0f\u4e8e 10s \u7684\u6709 40\u6b21",(0,t.jsx)(n.br,{}),"\n","\u8017\u65f6 \u5c0f\u4e8e \u65e0\u7a77\u5927\u7684\u6709 50\u6b21"]}),"\n",(0,t.jsx)(n.h3,{id:"summary",children:"Summary"}),"\n",(0,t.jsx)(n.p,{children:"\u6458\u8981, \u7c7b\u4f3c\u4e8e Histogram\uff0c\u4f46\u662f\u5b83\u4f1a\u4fdd\u7559\u4e00\u7cfb\u5217\u6307\u5b9a\u7684\u5206\u4f4d\u6570"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# HELP prometheus_tsdb_wal_fsync_duration_seconds Duration of WAL fsync.\n# TYPE prometheus_tsdb_wal_fsync_duration_seconds summary\nprometheus_tsdb_wal_fsync_duration_seconds{quantile="0.5"} 0.012352463\nprometheus_tsdb_wal_fsync_duration_seconds{quantile="0.9"} 0.014458005\nprometheus_tsdb_wal_fsync_duration_seconds{quantile="0.99"} 0.017316173\nprometheus_tsdb_wal_fsync_duration_seconds_sum 2.888716127000002\nprometheus_tsdb_wal_fsync_duration_seconds_count 216\n'})}),"\n",(0,t.jsxs)(n.p,{children:["\u64cd\u4f5c\u7684\u603b\u6b21\u6570\u4e3a216\u6b21\uff0c\u8017\u65f62.888716127000002s, \u6309\u8017\u65f6\u7ed9\u6240\u6709\u6b21\u6570\u6392\u5e8f",(0,t.jsx)(n.br,{}),"\n","\u4e2d\u4f4d\u6570\uff08quantile=0.5\uff09\u7684\u8017\u65f6\u4e3a0.012352463",(0,t.jsx)(n.br,{}),"\n","9\u5206\u4f4d\u6570\uff08quantile=0.9\uff09\u7684\u8017\u65f6\u4e3a0.014458005s"]}),"\n",(0,t.jsx)(n.h2,{id:"\u5339\u914d\u6570\u636e",children:"\u5339\u914d\u6570\u636e"}),"\n",(0,t.jsxs)(n.p,{children:["Prometheus \u91c7\u96c6\u7684\u6570\u636e\u6709\u7c7b\u522b\u548c\u65f6\u95f4\u4e24\u4e2a\u91cd\u8981\u5c5e\u6027, \u4ee5\u7a7a\u95f4\u5750\u6807\u8f74\u6bd4\u55bb",(0,t.jsx)(n.br,{}),"\n","x \u8f74\u7684\u70b9\u4e3a\u4e0d\u540c\u7684\u65f6\u95f4, y \u8f74\u4e0a\u4e0d\u540c\u70b9\u8868\u793a\u4e0d\u540c\u7c7b\u522b, z \u8f74\u8868\u793a\u6570\u636e\u7684\u503c"]}),"\n",(0,t.jsx)(n.p,{children:"\u4f7f\u7528 PromQL \u67e5\u8be2\u8fd4\u56de\u7684\u6570\u636e\u6709 4 \u79cd\u7c7b\u578b"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Instan vector: ",(0,t.jsx)(n.strong,{children:"\u77ac\u65f6\u5411\u91cf"}),", \u67d0\u4e2a\u65f6\u95f4\u70b9\u91c7\u96c6\u7684\u6570\u636e\u96c6\u5408"]}),"\n",(0,t.jsxs)(n.li,{children:["Range vector: ",(0,t.jsx)(n.strong,{children:"\u533a\u95f4\u5411\u91cf"}),", \u6307\u5b9a\u65f6\u95f4\u8303\u56f4\u5185, \u65e0\u6570\u77ac\u65f6\u5411\u91cf\u7684\u96c6\u5408"]}),"\n",(0,t.jsxs)(n.li,{children:["Scalar: ",(0,t.jsx)(n.strong,{children:"\u6807\u91cf"}),", \u6d6e\u70b9\u6570\u5b57, \u65e0\u65f6\u95f4\u7c7b\u522b\u5c5e\u6027"]}),"\n",(0,t.jsxs)(n.li,{children:["String: ",(0,t.jsx)(n.strong,{children:"\u5b57\u7b26\u4e32"})]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"\u5339\u914d",children:"\u5339\u914d"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u5b8c\u5168\u5339\u914d: \u7b49\u4e8e",(0,t.jsx)(n.code,{children:"="}),", \u4e0d\u7b49\u4e8e ",(0,t.jsx)(n.code,{children:"!="})]}),"\n",(0,t.jsxs)(n.li,{children:["\u6b63\u5219\u5339\u914d: \u6b63\u5411 ",(0,t.jsx)(n.code,{children:"=~"})," \u53cd\u5411 ",(0,t.jsx)(n.code,{children:"!~"})]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# cpu0\nnode_cpu_seconds_total{cpu="0"}\n\n# \u975e cpu0\nnode_cpu_seconds_total{cpu!="0"}\n\n# cpu0 job \u4e2d\u5305\u542b V2 \nnode_cpu_seconds_total{cpu="0",job=~".*V2.*"}\n\n# cpu0 job \u4e2d\u5305\u542b V2 \nnode_cpu_seconds_total{cpu="0",job!~".*V2.*"}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"\u8303\u56f4\u67e5\u8be2",children:"\u8303\u56f4\u67e5\u8be2"}),"\n",(0,t.jsxs)(n.p,{children:["\u4e0a\u8ff0\u67e5\u8be2\u7684\u7ed3\u679c\u90fd\u662f\u77ac\u65f6\u503c, \u662f\u4ece\u6700\u65b0\u7684\u6570\u636e\u67e5\u8be2, \u8fd9\u6837\u7684\u7ed3\u679c\u79f0\u4e3a",(0,t.jsx)(n.strong,{children:"\u77ac\u65f6\u5411\u91cf"}),(0,t.jsx)(n.br,{}),"\n","\u5b9e\u9645\u4e0a, prometheus \u83b7\u53d6\u7684\u6570\u636e\u662f\u5e26\u6709\u65f6\u95f4\u7684, \u4e00\u6bb5\u65f6\u95f4\u5185\u7684\u6570\u636e\u79f0\u4f5c",(0,t.jsx)(n.strong,{children:"\u533a\u95f4\u5411\u91cf"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# \u5728\u77ac\u65f6\u8868\u8fbe\u5f0f\u7ed3\u5c3e\u6dfb\u52a0 [time] \u8868\u793a\u4ece\u5f53\u524d\u5f80\u524d\u4e00\u6bb5\u65f6\u95f4\u7684\u6570\u636e\nnode_cpu_seconds_total{cpu="0", instance="10.143.232.175:9100", mode="idle"}[5m]\n> node_cpu_seconds_total{cpu="0", instance="10.143.232.175:9100", mode="idle"}  34848.9 @1708573601.411\n>                                                                               34863.28 @1708573616.411\n>                                                                               34877.63 @1708573631.411\n>                                                                               34892 @1708573646.411\n>                                                                               34906.3 @1708573661.411\n>                                                                               34920.6 @1708573676.411\n>                                                                               34934.85 @1708573691.411\n>                                                                               34949.08 @1708573706.411\n>                                                                               34963.29 @1708573721.411\n>                                                                               34977.53 @1708573736.411\n>                                                                               34991.82 @1708573751.411\n>                                                                               35006.06 @1708573766.411\n>                                                                               35020.08 @1708573781.411\n>                                                                               35034.16 @1708573796.411\n>                                                                               35048.44 @1708573811.411\n'})}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{style:{textAlign:"center"},children:"\u7b26\u53f7"}),(0,t.jsx)(n.th,{style:{textAlign:"center"},children:(0,t.jsx)(n.code,{children:"s"})}),(0,t.jsx)(n.th,{style:{textAlign:"center"},children:(0,t.jsx)(n.code,{children:"m"})}),(0,t.jsx)(n.th,{style:{textAlign:"center"},children:(0,t.jsx)(n.code,{children:"h"})}),(0,t.jsx)(n.th,{style:{textAlign:"center"},children:(0,t.jsx)(n.code,{children:"d"})}),(0,t.jsx)(n.th,{style:{textAlign:"center"},children:(0,t.jsx)(n.code,{children:"w"})}),(0,t.jsx)(n.th,{style:{textAlign:"center"},children:(0,t.jsx)(n.code,{children:"y"})})]})}),(0,t.jsx)(n.tbody,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"\u542b\u4e49"}),(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"\u79d2[5s]"}),(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"\u5206\u949f[5m]"}),(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"\u5c0f\u65f6[5h]"}),(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"\u5929[5d]"}),(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"\u5468[5w]"}),(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"\u5e74[5y]"})]})})]}),"\n",(0,t.jsxs)(n.p,{children:["\u9ed8\u8ba4\u67e5\u8be2\u90fd\u662f\u4ee5\u5f53\u524d\u65f6\u95f4\u4f5c\u4e3a\u57fa\u51c6, \u53d6\u5f53\u524d\u65f6\u95f4\u70b9\u6216\u8005, \u5f53\u524d\u5f80\u524d\u63a8\u4e00\u6bb5\u65f6\u95f4",(0,t.jsx)(n.br,{}),"\n","\u82e5\u8981\u66f4\u6362\u65f6\u95f4\u57fa\u51c6, \u5982 1 \u5929\u524d\u540c\u4e00\u65f6\u523b, \u6216\u8005\u6628\u5929\u4e00\u6574\u5929\u7684\u6570\u636e, \u4f7f\u7528 ",(0,t.jsx)(n.strong,{children:"offset"})," \u5207\u6362\u65f6\u95f4\u57fa\u51c6"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# \u5f53\u524d\u65f6\u95f4\u5f80\u524d\u63a8 1 \u5929\nnode_cpu_seconds_total{cpu="0", instance="10.143.232.175:9100", mode="idle"} offset 1d\n\n# \u5f53\u524d\u662f 02/22 10:00, \u5148\u5f80\u524d\u63a8 10 \u5c0f\u65f6\u5230 00:00, \u518d\u53d6 00:00 \u5f80\u524d 1 \u5929\u7684\u6570\u636e\nnode_cpu_seconds_total{cpu="0", instance="10.143.232.175:9100", mode="idle"}[1d] offset 10h\n'})}),"\n",(0,t.jsx)(n.h2,{id:"\u805a\u5408\u64cd\u4f5c",children:"\u805a\u5408\u64cd\u4f5c"}),"\n",(0,t.jsx)(n.p,{children:"\u5bf9\u77ac\u65f6\u5411\u91cf\u8fdb\u884c\u805a\u5408\u64cd\u4f5c"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["sum: ",(0,t.jsx)(n.code,{children:'\u6c42\u548c sum(node_cpu_seconds_total{cpu="0"})'})]}),"\n",(0,t.jsxs)(n.li,{children:["min: ",(0,t.jsx)(n.code,{children:'\u6700\u5c0f\u503c min(node_cpu_seconds_total{cpu="0"})'})]}),"\n",(0,t.jsxs)(n.li,{children:["max: ",(0,t.jsx)(n.code,{children:'\u6700\u5927\u503c max(node_cpu_seconds_total{cpu="0"})'})]}),"\n",(0,t.jsxs)(n.li,{children:["avg: ",(0,t.jsx)(n.code,{children:'\u5e73\u5747\u503c avg(node_cpu_seconds_total{cpu="0"})'})]}),"\n",(0,t.jsxs)(n.li,{children:["count: ",(0,t.jsx)(n.code,{children:'\u8ba1\u6570 count(node_cpu_seconds_total{cpu="0"})'})]}),"\n",(0,t.jsxs)(n.li,{children:["topk: ",(0,t.jsx)(n.code,{children:'\u524d n \u6761\u6570\u636e topk(5, node_cpu_seconds_total{cpu="0"})'})]}),"\n",(0,t.jsxs)(n.li,{children:["bottomk: ",(0,t.jsx)(n.code,{children:'\u6700\u540e n \u6761\u6570\u636e bottomkk(5, node_cpu_seconds_total{cpu="0"})'})]}),"\n",(0,t.jsx)(n.li,{children:"stddev: \u6807\u51c6\u5dee"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"\u6570\u5b66\u8fd0\u7b97",children:"\u6570\u5b66\u8fd0\u7b97"}),"\n",(0,t.jsxs)(n.p,{children:["\u77ac\u65f6\u5411\u91cf\u53ef\u4ee5\u76f4\u63a5\u4e0e\u6807\u91cf\u8ba1\u7b97, \u5982 Memory \u539f\u59cb\u6570\u636e\u5355\u4f4d\u662f Byte, \u9664\u4ee5 1024, \u5355\u4f4d\u53d8\u6210 KB\n\u77ac\u65f6\u5411\u91cf\u548c\u77ac\u65f6\u5411\u91cf\u8fd0\u7b97, \u53ea\u6709 ",(0,t.jsx)(n.code,{children:"{label0=value, label1=value}"})," \u5b8c\u5168\u4e00\u81f4\u624d\u4f1a\u8ba1\u7b97",(0,t.jsx)(n.br,{}),"\n","\u4f7f\u7528 ",(0,t.jsx)(n.code,{children:"on"})," \u6216 ",(0,t.jsx)(n.code,{children:"ignore"})," \u8ba9\u4e0d\u540c\u6807\u7b7e\u7684\u5411\u91cf\u4e5f\u80fd\u505a\u6570\u5b66\u8fd0\u7b97"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"node_cpu_seconds_total  +  on(instance, job, mode, cpu) node_cpu_guest_seconds_total\n"})}),"\n",(0,t.jsx)(n.h2,{id:"\u5185\u7f6e\u51fd\u6570",children:"\u5185\u7f6e\u51fd\u6570"}),"\n",(0,t.jsx)(n.h3,{id:"increase",children:"increase"}),"\n",(0,t.jsxs)(n.p,{children:["\u8ba1\u7b97\u4e00\u4e2a Counter \u6570\u636e\u7684\u589e\u957f, \u53d6\u6700\u540e\u65f6\u523b\u7684\u6570\u636e\u51cf\u53bb\u6700\u521d\u65f6\u523b\u7684\u6570\u636e",(0,t.jsx)(n.br,{}),"\n",(0,t.jsx)(n.code,{children:"increase(range-vector)"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'increase(node_cpu_seconds_total{cpu="0", instance="10.143.232.175:9100", job="V2-Node",mode="idle"}[5m])\n> {cpu="0", instance="10.143.232.175:9100", job="V2-Node", mode="idle"}    \t218.2709700476184\n'})}),"\n",(0,t.jsx)(n.h3,{id:"rate",children:"rate"}),"\n",(0,t.jsxs)(n.p,{children:["\u8ba1\u7b97\u5e73\u5747\u6bcf\u79d2\u7684\u589e\u957f, \u5373\u589e\u957f\u91cf\u9664\u4ee5\u65f6\u95f4\n",(0,t.jsx)(n.code,{children:"rate(range-vector) == increase(range-vector) / time"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'rate(node_cpu_seconds_total{cpu="0", instance="10.143.232.175:9100", job="V2-Node",mode="idle"}[5m])\n> {cpu="0", instance="10.143.232.175:9100", job="V2-Node", mode="idle"}    \t\t0.7518475626666798\n'})}),"\n",(0,t.jsx)(n.h3,{id:"irate",children:"irate"}),"\n",(0,t.jsx)(n.p,{children:"\u8ba1\u7b97\u6700\u540e\u4e24\u7ec4\u6570\u636e\u7684\u589e\u957f\u7387(\u77ac\u65f6\u53d8\u5316): \u6700\u540e\u7684\u6570\u636e - \u6700\u540e\u524d\u4e00\u6b21\u6570\u636e / \u4e24\u4e2a\u6570\u636e\u65f6\u95f4\u5dee"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# \u7531\u4e8e\u4ec5\u53d6\u6700\u540e\u4e24\u7ec4\u6570\u636e, \u5728\u540c\u4e00\u4e2a\u65f6\u95f4\u70b9, [2m] [5m] (\u65e0\u8bba\u5f80\u524d\u63a8\u591a\u5c11\u65f6\u95f4)\u7684\u6700\u540e\u4e24\u7ec4\u6570\u636e\u4e00\u81f4, \u7ed3\u679c\u4e5f\u4e00\u81f4\nirate(node_cpu_seconds_total{cpu="0", instance="10.143.232.175:9100", job="V2-Node",mode="idle"}[2m])\n> {cpu="0", instance="10.143.232.175:9100", job="V2-Node", mode="idle"}       0.8286666666666861\n'})}),"\n",(0,t.jsx)(n.h2,{id:"\u793a\u4f8b",children:"\u793a\u4f8b"}),"\n",(0,t.jsx)(n.h3,{id:"\u8282\u70b9\u8fde\u63a5",children:"\u8282\u70b9\u8fde\u63a5"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# job \u4e2d\u5305\u542b Node \u7684(1 \u8fde\u63a5, 0 \u65ad\u8fde)\nup{job=~".*Node"}\nup{instance="10.121.238.42:6100", job="V2-Node"}     1\nup{instance="10.121.238.42:7100", job="V2-Node"}     1\nup{instance="10.143.232.175:9100", job="V2-Node"}    1\nup{instance="10.144.226.244:9100", job="V1-Node"}    1\n'})}),"\n",(0,t.jsx)(n.h3,{id:"cpu-\u5360\u7528\u7387",children:"CPU \u5360\u7528\u7387"}),"\n",(0,t.jsxs)(n.p,{children:["/proc/stat \u4fdd\u5b58 CPU \u6267\u884c\u65f6\u95f4\u6570\u636e(",(0,t.jsx)(n.a,{href:"#counter",children:"Counter"}),"\u7c7b\u578b)",(0,t.jsx)(n.br,{}),"\n","CPU \u5360\u7528: \u4e00\u6bb5\u65f6\u95f4\u5185, CPU \u5de5\u4f5c\u65f6\u95f4(\u603b\u65f6\u95f4 - \u7a7a\u95f2\u65f6\u95f4)\u5360\u603b\u65f6\u95f4\u7684\u6bd4\u503c"]}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{style:{textAlign:"center"},children:"\u5b57\u6bb5"}),(0,t.jsx)(n.th,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"user"})}),(0,t.jsx)(n.th,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"nice"})}),(0,t.jsx)(n.th,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"system"})}),(0,t.jsx)(n.th,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"idle"})}),(0,t.jsx)(n.th,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"iowait"})}),(0,t.jsx)(n.th,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"irq"})}),(0,t.jsx)(n.th,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"softirq"})}),(0,t.jsx)(n.th,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"steal/guest/guest_nice"})})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"\u503c"}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"1128155"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"0"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"990765"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"52801349"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"8147"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"0"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"5547"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"0/0/0"})})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"\u542b\u4e49"}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"\u7528\u6237\u6001\u65f6\u95f4"}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"\u4f4e\u4f18\u5148\u7ea7\u7528\u6237\u6001\u65f6\u95f4"}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"\u5185\u6838\u6001\u65f6\u95f4"}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"\u7a7a\u95f2\u65f6\u95f4"}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"I/O\u7b49\u5f85\u65f6\u95f4"}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"\u786c\u4e2d\u65ad\u65f6\u95f4"}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"\u8f6f\u4e2d\u65ad\u65f6\u95f4"}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"\u865a\u62df\u673a\u5360\u7528\u65f6\u95f4"})]})]})]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"CPU Used = 1 - (idle / (user + nice + system + idle + iowait + irq + softirq + steal + guest + guest_nice))"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# 2m \u6700\u540e\u4e24\u7ec4\u6570\u636e\u8ba1\u7b97\u5e73\u5747\u589e\u957f\u7387\nirate(node_cpu_seconds_total{mode="idle"}[2m])\nirate(node_cpu_seconds_total[2m])\n\n# 1 \u51cf\u53bb\u7a7a\u95f2\u767e\u5206\u6bd4\u83b7\u5f97 CPU \u5360\u7528\u767e\u5206\u6bd4(\u6309)\n1 - (sum by(instance) (irate(node_cpu_seconds_total{mode="idle"}[2m])) / sum by(instance) (irate(node_cpu_seconds_total[2m])))\n1 - ((irate(node_cpu_seconds_total{mode="idle", instance="192.168.1.100"}[2m])) / (irate(node_cpu_seconds_total{instance="192.168.1.100"}[2m])))\n'})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# \u6ce8: sum by \u8bed\u53e5\u540e\u4ec5\u4fdd\u7559\u8bbe\u7f6e\u7684\u7d22\u5f15, \u7c7b\u4f3c\u4e8e pandas \u7684 groupby\nsum by(job,instance) (node_cpu_seconds_total{mode="idle"})\n{instance="10.121.238.42:1100", job="V2-Node"}        192876.24\n{instance="10.121.238.42:2100", job="V2-Node"}        1113100.96\n{instance="10.121.238.42:6100", job="V2-Node"}        1156084.41\n{instance="10.121.238.42:7100", job="V2-Node"}        1154130.68\n'})}),"\n",(0,t.jsx)(n.h3,{id:"\u5185\u5b58\u5360\u7528",children:"\u5185\u5b58\u5360\u7528"}),"\n",(0,t.jsxs)(n.p,{children:["/proc/meminfo \u4fdd\u5b58 Memory \u6570\u636e(",(0,t.jsx)(n.a,{href:"#gauge",children:"Gauge"}),"\u7c7b\u578b)",(0,t.jsx)(n.br,{}),"\n","Memory Used: (MemTotal - MemAvailable) / MemTotal"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# \u5df2\u4f7f\u7528\u5185\u5b58(\u5355\u4f4d Byte)\nnode_memory_MemTotal_bytes - node_memory_MemAvailable_bytes\n\n# \u5df2\u4f7f\u7528\u5185\u5b58(\u5355\u4f4d GB)\n(node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / 1024 / 1024 / 1024\n\n# \u5185\u5b58\u5360\u7528\u767e\u5206\u6bd4\n(node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) /  node_memory_MemTotal_bytes\n"})}),"\n",(0,t.jsx)(n.h3,{id:"\u786c\u76d8\u5360\u7528",children:"\u786c\u76d8\u5360\u7528"}),"\n",(0,t.jsx)(n.p,{children:"Disk Used: 1- (Disk Available / Disk Total)"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# \u53ef\u7528\u7a7a\u95f4\nnode_filesystem_avail_bytes\n\n# \u786c\u76d8\u603b\u7a7a\u95f4\nnode_filesystem_size_bytes\n\n1 - ((node_filesystem_avail_bytes) /  node_filesystem_size_bytes)\n"})}),"\n",(0,t.jsx)(n.h2,{id:"api",children:"API"}),"\n",(0,t.jsx)(n.p,{children:"prometheus \u63d0\u4f9b\u4e86API, \u53ef\u4ee5\u901a\u8fc7 API \u83b7\u53d6\u6570\u636e"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'import requests\n\n# \u67e5\u8be2\u77ac\u65f6\u6570\u636e\nquery_url = "http://localhost:9090/api/v1/query"\nr = requests.get(query_url, params={"query": \'node_cpu_seconds_total{mode="idle", "instance": "192.168.1.100:9100", "cpu"="0"}\'})\nr.json()\n\n{\n  "status": "success",\n  "data": {\n    "resultType": "vector",\n    "result": [\n      {\n        "metric": {\n        "__name__": "node_cpu_seconds_total",\n        "cpu": "0",\n        "instance": "192.168.1.100:9100",\n        "job": "Node",\n        "mode": "idle"\n        },\n        "value": [1719297314.563, "26458.92"]\n      }\n    ]\n  }\n}\n\n# \u67e5\u8be2\u65f6\u95f4\u6bb5\u6570\u636e\nquery_range_url = "http://localhost:9090/api/v1/query_range"\nr = requests.get(query_range_url, params={\n  "query": \'node_cpu_seconds_total{mode="idle", "instance": "192.168.1.100:9100", "cpu"="0"}\', \n  "start": "2024-06-25T12:00:00+08:00", \n  "end": "2024-06-25T12:05:00+08:00",\n  "step": "1m"\n})\nr.json()\n\n{\n  "status": "success",\n  "data": {\n    "resultType": "matrix",\n    "result": [\n      {\n        "metric": {\n          "__name__": "node_cpu_seconds_total",\n          "cpu": "0",\n          "instance": "192.168.1.100:9100",\n          "job": "Node",\n          "mode": "idle"\n        },\n        "values": [\n          [1719230400, "4454.3"],\n          [1719230460, "4504.85"],\n          [1719230520, "4555.09"],\n          [1719230580, "4605.51"],\n          [1719230640, "4655.95"],\n          [1719230700, "4697.64"]\n        ]\n      }\n    ]\n  }\n}\n'})})]})}function u(e={}){const{wrapper:n}={...(0,d.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(a,{...e})}):a(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>c,x:()=>o});var t=s(6540);const d={},l=t.createContext(d);function c(e){const n=t.useContext(l);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(d):e.components||d:c(e.components),t.createElement(l.Provider,{value:n},e.children)}}}]);