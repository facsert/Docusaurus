"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[4166],{6737:(n,e,r)=>{r.r(e),r.d(e,{assets:()=>c,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>l,toc:()=>a});var s=r(4848),t=r(8453);const o={author:"facsert",pubDatetime:new Date("2023-07-28T09:31:54.000Z"),title:"Go SSH",slug:"Go SSH",featured:!1,draft:!1,tags:["Go","ssh"],description:"Go SSH \u8fde\u63a5"},i=void 0,l={id:"Go/modules/go-ssh",title:"Go SSH",description:"Go SSH \u8fde\u63a5",source:"@site/docs/Go/modules/go-ssh.md",sourceDirName:"Go/modules",slug:"/Go/modules/Go SSH",permalink:"/docs/Go/modules/Go SSH",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Go/modules/go-ssh.md",tags:[{inline:!0,label:"Go",permalink:"/docs/tags/go"},{inline:!0,label:"ssh",permalink:"/docs/tags/ssh"}],version:"current",frontMatter:{author:"facsert",pubDatetime:"2023-07-28T09:31:54.000Z",title:"Go SSH",slug:"Go SSH",featured:!1,draft:!1,tags:["Go","ssh"],description:"Go SSH \u8fde\u63a5"},sidebar:"tutorialSidebar",previous:{title:"Go grpc",permalink:"/docs/Go/modules/Go grpc"},next:{title:"Go Swagger",permalink:"/docs/Go/modules/Go Swagger"}},c={},a=[{value:"Table of Contents",id:"table-of-contents",level:2},{value:"\u521b\u5efa\u9879\u76ee",id:"\u521b\u5efa\u9879\u76ee",level:2},{value:"\u6d41\u7a0b",id:"\u6d41\u7a0b",level:3},{value:"\u8bbe\u8ba1",id:"\u8bbe\u8ba1",level:2},{value:"\u5b9e\u73b0",id:"\u5b9e\u73b0",level:2},{value:"\u4ee3\u7801",id:"\u4ee3\u7801",level:2},{value:"\u62d3\u5c55",id:"\u62d3\u5c55",level:2}];function u(n){const e={br:"br",code:"code",h2:"h2",h3:"h3",p:"p",pre:"pre",...(0,t.R)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.h2,{id:"table-of-contents",children:"Table of Contents"}),"\n",(0,s.jsxs)(e.p,{children:["Go \u5b9e\u73b0 ssh \u8fde\u63a5\u8fdc\u7aef\u5e76\u53d1\u9001\u547d\u4ee4\u6267\u884c",(0,s.jsx)(e.br,{}),"\n",(0,s.jsx)(e.code,{children:"golang.org/x/crypto/ssh"})]}),"\n",(0,s.jsx)(e.h2,{id:"\u521b\u5efa\u9879\u76ee",children:"\u521b\u5efa\u9879\u76ee"}),"\n",(0,s.jsx)(e.p,{children:"\u521b\u5efa sshClient \u9879\u76ee, \u6dfb\u52a0 ssh \u5e93"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:' $ mkdir sshClient\n $ cd sshClient && go mod init sshClient\n $ touch main.go\n $ go get -u "golang.org/x/crypto/ssh"\n\n $ ls -l\n > total 12\n > -rw-r--r-- 1 root root 115 Jul 27 02:58 go.mod\n > -rw-r--r-- 1 root root 312 Jul 27 02:58 go.sum\n > -rw-r--r-- 1 root root 973 Jul 27 04:20 main.go\n'})}),"\n",(0,s.jsx)(e.h3,{id:"\u6d41\u7a0b",children:"\u6d41\u7a0b"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"# ssh.Dial \u914d\u7f6e server \u4fe1\u606f\u751f\u6210 client \u5bf9\u8c61\n# client \u521b\u5efa\u4e00\u4e2a session \u6267\u884c linux \u547d\u4ee4\u5e76\u83b7\u53d6\u8fd4\u56de\u503c\n\n      server config               new                      command\nssh.Dial ---\x3e client(*ssh.Client) ---\x3e session(*ssh.Session) ---\x3e server\n                         1                      N\n\n# \u5355\u4e2a client \u53ef\u4ee5\u521b\u5efa\u591a\u4e2a session \u6267\u884c linux \u6307\u4ee4\n# session \u6267\u884c\u6307\u4ee4\u5931\u8d25\u6216\u8005\u547d\u4ee4\u8fd4\u56de\u503c\u4e0d\u4e3a 0 \u5219\u62a5\u9519\n"})}),"\n",(0,s.jsx)(e.h2,{id:"\u8bbe\u8ba1",children:"\u8bbe\u8ba1"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:"type Server struct {\n    host     string\n    port     string\n    username string\n    password string\n    timeout  int32\n    command  string\n}\n\nfunc Connect(server Server) (*ssh.Client, error) { ... }\nfunc Run(client *ssh.Client, command string) (string, error) { ... }\n"})}),"\n",(0,s.jsx)(e.h2,{id:"\u5b9e\u73b0",children:"\u5b9e\u73b0"}),"\n",(0,s.jsxs)(e.p,{children:[(0,s.jsx)(e.code,{children:"func Connect(server Server) (*ssh.Client, error)"}),(0,s.jsx)(e.br,{}),"\n","\u63a5\u53d7\u4e00\u4e2a Server \u7ed3\u6784\u4f53, \u901a\u8fc7 server \u5c5e\u6027\u751f\u6210 *ssh.Client \u5bf9\u8c61"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:'func Connect(server Server) (*ssh.Client, error) {\n    config := ssh.ClientConfig{\n        User:            server.username,\n        Auth:            []ssh.AuthMethod{ssh.Password(server.password)},\n        Timeout:         time.Duration(server.timeout) * time.Second,\n        HostKeyCallback: ssh.InsecureIgnoreHostKey(),\n    }\n\n    sshClient, err := ssh.Dial("tcp", fmt.Sprintf("%s:%s", server.host, server.port), &config)\n    if err != nil {\n        fmt.Printf("Connect host %s error: %v\\n", server.host, err)\n        return nil, err\n    }\n    return sshClient, nil\n}\n'})}),"\n",(0,s.jsxs)(e.p,{children:[(0,s.jsx)(e.code,{children:"func Run(client *ssh.Client, command string) (string, error) { ... }"}),(0,s.jsx)(e.br,{}),"\n","\u63a5\u53d7 Connect \u8fd4\u56de\u7684 client \u5bf9\u8c61, \u548c\u6267\u884c\u7684 linux \u547d\u4ee4, \u8fd4\u56de\u6267\u884c\u7ed3\u679c"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:'func Run(client *ssh.Client, command string) (string, error) {\n    session, err := client.NewSession()\n    if err != nil {\n        return fmt.Sprintf("create session failed: %v\\n", err), err\n    }\n    defer session.Close()\n\n    output, err := session.CombinedOutput(command)\n    if err != nil {\n        return string(output), err\n    }\n    return string(output), nil\n}\n'})}),"\n",(0,s.jsx)(e.h2,{id:"\u4ee3\u7801",children:"\u4ee3\u7801"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:'package main\n\nimport (\n    "fmt"\n    "time"\n\n    "golang.org/x/crypto/ssh"\n)\n\ntype Server struct {\n    host     string\n    port     string\n    username string\n    password string\n    timeout  int32\n    command  string\n}\n\nfunc main() {\n    server := Server {\n        host    : "127.0.0.1",\n        port    : "22",\n        username: "root",\n        password: "admin",\n        timeout : 60,\n        command : "date",\n    }\n\n    client, err := Connect(server)\n    if err != nil {\n        panic(fmt.Sprintf("Connect %s failed!", server.host))\n    }\n\n    output, err := Run(client, server.command)\n    if err != nil {\n        panic(fmt.Sprintf("%s run error: %v\\n", server.command, err))\n    }\n    fmt.Println(output)\n}\n\nfunc Connect(server Server) (*ssh.Client, error) {\n    config := ssh.ClientConfig{\n        User:            server.username,\n        Auth:            []ssh.AuthMethod{ssh.Password(server.password)},\n        Timeout:         time.Duration(server.timeout) * time.Second,\n        HostKeyCallback: ssh.InsecureIgnoreHostKey(),\n    }\n\n    sshClient, err := ssh.Dial("tcp", fmt.Sprintf("%s:%s", server.host, server.port), &config)\n    if err != nil {\n        fmt.Printf("Connect host %s error: %v\\n", server.host, err)\n        return nil, err\n    }\n    return sshClient, nil\n}\n\nfunc Run(client *ssh.Client, command string) (string, error) {\n    session, err := client.NewSession()\n    if err != nil {\n        return fmt.Sprintf("create session failed: %v\\n", err), err\n    }\n    defer session.Close()\n\n    output, err := session.CombinedOutput(command)\n    if err != nil {\n        return string(output), err\n    }\n    return string(output), nil\n}\n'})}),"\n",(0,s.jsx)(e.h2,{id:"\u62d3\u5c55",children:"\u62d3\u5c55"}),"\n",(0,s.jsx)(e.p,{children:"\u6a21\u62df\u5b9e\u73b0\u7ec8\u7aef"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:'func Termiunal(client *ssh.Client) {\n    session, err := client.NewSession()\n    if err != nil {\n        panic(fmt.Sprintf("create session failed: %v\\n", err))\n    }\n    defer session.Close()\n\n    session.Stdout = os.Stdout                   // \u4f1a\u8bdd\u8f93\u51fa\u5173\u8054\u5230\u7cfb\u7edf\u6807\u51c6\u8f93\u51fa\u8bbe\u5907\n    session.Stderr = os.Stderr                   // \u4f1a\u8bdd\u9519\u8bef\u8f93\u51fa\u5173\u8054\u5230\u7cfb\u7edf\u6807\u51c6\u9519\u8bef\u8f93\u51fa\u8bbe\u5907\n    session.Stdin = os.Stdin                     // \u4f1a\u8bdd\u8f93\u5165\u5173\u8054\u5230\u7cfb\u7edf\u6807\u51c6\u8f93\u5165\u8bbe\u5907\n    modes := ssh.TerminalModes{\n        ssh.ECHO:          0,                    // \u7981\u7528\u56de\u663e\uff08\u4e0d\u91cd\u590d\u663e\u793a\u6267\u884c\u547d\u4ee4 0\u7981\u7528\uff0c1\u542f\u52a8\uff09\n        ssh.TTY_OP_ISPEED: 14400,                // input speed = 14.4kbaud\n        ssh.TTY_OP_OSPEED: 14400,                // output speed = 14.4kbaud\n    }\n\n    if err = session.RequestPty("linux", 32, 160, modes); err != nil {\n        panic(fmt.Sprintf("request pty error: %v\\n", err))\n    }\n    if err = session.Shell(); err != nil {\n        panic(fmt.Sprintf("start shell error: %v", err))\n    }\n    if err = session.Wait(); err != nil {\n        panic(fmt.Sprintf("return error: %v", err))\n    }\n}\n'})})]})}function d(n={}){const{wrapper:e}={...(0,t.R)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(u,{...n})}):u(n)}},8453:(n,e,r)=>{r.d(e,{R:()=>i,x:()=>l});var s=r(6540);const t={},o=s.createContext(t);function i(n){const e=s.useContext(o);return s.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function l(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(t):n.components||t:i(n.components),s.createElement(o.Provider,{value:e},n.children)}}}]);