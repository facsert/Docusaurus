"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[2523],{1190:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>d,default:()=>h,frontMatter:()=>l,metadata:()=>c,toc:()=>i});var s=t(4848),r=t(8453);const l={author:"facsert",pubDatetime:new Date("2023-12-13T21:51:08.000Z"),title:"Python APScheduler",slug:"Python APScheduler",featured:!1,draft:!1,tags:["Python","APScheduler"],description:"Python \u5b9a\u65f6\u4efb\u52a1\u6846\u67b6 APScheduler"},d=void 0,c={id:"Python/python-apscheduler",title:"Python APScheduler",description:"Python \u5b9a\u65f6\u4efb\u52a1\u6846\u67b6 APScheduler",source:"@site/docs/Python/python-apscheduler.md",sourceDirName:"Python",slug:"/Python/Python APScheduler",permalink:"/docs/Python/Python APScheduler",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Python/python-apscheduler.md",tags:[{inline:!0,label:"Python",permalink:"/docs/tags/python"},{inline:!0,label:"APScheduler",permalink:"/docs/tags/ap-scheduler"}],version:"current",frontMatter:{author:"facsert",pubDatetime:"2023-12-13T21:51:08.000Z",title:"Python APScheduler",slug:"Python APScheduler",featured:!1,draft:!1,tags:["Python","APScheduler"],description:"Python \u5b9a\u65f6\u4efb\u52a1\u6846\u67b6 APScheduler"},sidebar:"tutorialSidebar",previous:{title:"PromQl",permalink:"/docs/Prometheus/PromQl"},next:{title:"Python Class",permalink:"/docs/Python/Python Class"}},o={},i=[{value:"Table of Contents",id:"table-of-contents",level:2},{value:"\u5b89\u88c5\u4e0e\u4ecb\u7ecd",id:"\u5b89\u88c5\u4e0e\u4ecb\u7ecd",level:2},{value:"\u57fa\u672c\u4f7f\u7528",id:"\u57fa\u672c\u4f7f\u7528",level:2},{value:"cron \u89e6\u53d1\u5668",id:"cron-\u89e6\u53d1\u5668",level:2},{value:"interval \u89e6\u53d1\u5668",id:"interval-\u89e6\u53d1\u5668",level:2},{value:"date \u89e6\u53d1\u5668",id:"date-\u89e6\u53d1\u5668",level:2},{value:"\u4efb\u52a1\u5b58\u50a8",id:"\u4efb\u52a1\u5b58\u50a8",level:2},{value:"\u4efb\u52a1\u8c03\u5ea6",id:"\u4efb\u52a1\u8c03\u5ea6",level:2},{value:"\u793a\u4f8b",id:"\u793a\u4f8b",level:2}];function a(e){const n={br:"br",code:"code",h2:"h2",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h2,{id:"table-of-contents",children:"Table of Contents"}),"\n",(0,s.jsxs)(n.p,{children:["APScheduler \u662f\u4e00\u4e2a Python \u5b9a\u65f6\u4efb\u52a1\u6846\u67b6, \u652f\u6301 Cron\u3001Interval\u3001Date\u3001Timeout \u7b49\u7c7b\u578b\u7684\u4efb\u52a1,",(0,s.jsx)(n.br,{}),"\n","\u652f\u6301\u5206\u5e03\u5f0f\u4efb\u52a1, \u652f\u6301\u4efb\u52a1\u5931\u8d25\u91cd\u8bd5, \u652f\u6301\u4efb\u52a1\u5e76\u53d1\u9650\u5236, \u652f\u6301\u4efb\u52a1\u72b6\u6001\u76d1\u63a7, \u652f\u6301\u4efb\u52a1\u65e5\u5fd7\u8bb0\u5f55"]}),"\n",(0,s.jsx)(n.h2,{id:"\u5b89\u88c5\u4e0e\u4ecb\u7ecd",children:"\u5b89\u88c5\u4e0e\u4ecb\u7ecd"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:' $ pip install apscheduler\n $ python -c "import apscheduler" && echo "Installed"\n > Installed\n'})}),"\n",(0,s.jsx)(n.p,{children:"apscheduler \u6709\u56db\u4e2a\u57fa\u672c\u5bf9\u8c61"}),"\n",(0,s.jsxs)(n.p,{children:["scheduler: \u8c03\u5ea6\u5668, \u7528\u4e8e\u8c03\u5ea6\u4efb\u52a1",(0,s.jsx)(n.br,{}),"\n","job: \u4efb\u52a1, \u5b9a\u4e49\u4e86\u4efb\u52a1\u6267\u884c\u7684\u5185\u5bb9",(0,s.jsx)(n.br,{}),"\n","trigger: \u89e6\u53d1\u5668, \u7528\u4e8e\u5b9a\u4e49\u4efb\u52a1\u6267\u884c\u7684\u89c4\u5219",(0,s.jsx)(n.br,{}),"\n","executor: \u6267\u884c\u5668, \u7528\u4e8e\u6267\u884c\u4efb\u52a1"]}),"\n",(0,s.jsx)(n.h2,{id:"\u57fa\u672c\u4f7f\u7528",children:"\u57fa\u672c\u4f7f\u7528"}),"\n",(0,s.jsxs)(n.p,{children:["\u56db\u79cd\u8c03\u5ea6\u5668:",(0,s.jsx)(n.br,{}),"\n","BlockingScheduler: \u963b\u585e\u8c03\u5ea6\u5668, \u9002\u7528\u4e8e\u5355\u7ebf\u7a0b\u7684\u5e94\u7528",(0,s.jsx)(n.br,{}),"\n","BackgroundScheduler: \u540e\u53f0\u8c03\u5ea6, \u4e0d\u5f71\u54cd\u4e3b\u7ebf\u7a0b",(0,s.jsx)(n.br,{}),"\n","AsyncIOScheduler: \u5f02\u6b65IO\u8c03\u5ea6\u5668, \u9002\u7528\u4e8e\u591a\u7ebf\u7a0b\u7684\u5e94\u7528",(0,s.jsx)(n.br,{}),"\n","GeventScheduler: gevent \u8c03\u5ea6\u5668, \u9002\u7528\u4e8e\u591a\u7ebf\u7a0b\u7684\u5e94\u7528"]}),"\n",(0,s.jsxs)(n.p,{children:["\u4e09\u79cd\u89e6\u53d1\u5668:",(0,s.jsx)(n.br,{}),"\n","cron: \u57fa\u4e8e Cron \u8868\u8fbe\u5f0f\u7684\u89e6\u53d1(\u5468\u671f\u6027)",(0,s.jsx)(n.br,{}),"\n","interval: \u56fa\u5b9a\u95f4\u9694\u89e6\u53d1",(0,s.jsx)(n.br,{}),"\n","date: \u57fa\u4e8e\u65e5\u671f, \u7279\u5b9a\u65f6\u95f4\u53ea\u89e6\u53d1\u4e00\u6b21"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-py",children:"from apscheduler.schedulers.background import BackgroundScheduler\n\ndef func(name='John'):\n    print(f'Hello, world!, {name}')\n\n\nschedule = BackgroundScheduler()                 # \u9009\u62e9\u4e00\u79cd\u8c03\u5ea6\u5668\nschedule.add_job(func, 'interval', seconds=5)    # \u6bcf 5s \u6267\u884c\u4e00\u6b21\nscheculer.add_job(func, 'cron', minute='*/5')    # \u6bcf 5 \u5206\u949f\u6267\u884c\u4e00\u6b21\n\n\ndate = '2024-01-04 12:00:00'                     # \u56fa\u5b9a\u65f6\u95f4\u6267\u884c\u4e00\u6b21\nschedule.add_job(func, 'date', run_date=date, args=['lily'])\n"})}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{style:{textAlign:"left"},children:"add_job \u53c2\u6570"}),(0,s.jsx)(n.th,{style:{textAlign:"left"},children:"\u542b\u4e49"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{style:{textAlign:"left"},children:"func"}),(0,s.jsx)(n.td,{style:{textAlign:"left"},children:"\u4efb\u52a1\u51fd\u6570"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{style:{textAlign:"left"},children:"trigger"}),(0,s.jsx)(n.td,{style:{textAlign:"left"},children:"\u89e6\u53d1\u5668"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{style:{textAlign:"left"},children:"args"}),(0,s.jsx)(n.td,{style:{textAlign:"left"},children:"\u4efb\u52a1\u51fd\u6570\u7684\u53c2\u6570"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{style:{textAlign:"left"},children:"kwargs"}),(0,s.jsx)(n.td,{style:{textAlign:"left"},children:"\u4efb\u52a1\u51fd\u6570\u7684\u53c2\u6570"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{style:{textAlign:"left"},children:"id"}),(0,s.jsx)(n.td,{style:{textAlign:"left"},children:"\u4efb\u52a1\u7684\u552f\u4e00\u6807\u8bc6\u7b26"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{style:{textAlign:"left"},children:"name"}),(0,s.jsx)(n.td,{style:{textAlign:"left"},children:"\u4efb\u52a1\u7684\u540d\u79f0"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{style:{textAlign:"left"},children:"misfire_grace_time"}),(0,s.jsx)(n.td,{style:{textAlign:"left"},children:"\u4efb\u52a1\u5931\u8d25\u91cd\u8bd5\u65f6\u95f4"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{style:{textAlign:"left"},children:"coalesce"}),(0,s.jsx)(n.td,{style:{textAlign:"left"},children:"\u662f\u5426\u5141\u8bb8\u4efb\u52a1\u91cd\u590d\u6267\u884c"})]})]})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"from apscheduler.schedulers.blocking import BlockingScheduler\n\ndef job_func():\n    print('Hello, world!')\n\nscheduler = BlockingScheduler()\nscheduler.add_job(job_func, trigger=\"cron\", second='*/5')\n"})}),"\n",(0,s.jsx)(n.h2,{id:"cron-\u89e6\u53d1\u5668",children:"cron \u89e6\u53d1\u5668"}),"\n",(0,s.jsx)(n.p,{children:"croon \u89e6\u53d1\u5668\u5f88\u5f3a\u5927, \u652f\u6301\u591a\u79cd\u8868\u8fbe\u5f0f\u4ee5\u8868\u793a\u5468\u671f\u6216\u8005\u95f4\u9694"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{style:{textAlign:"center"},children:"\u53c2\u6570"}),(0,s.jsx)(n.th,{style:{textAlign:"center"},children:(0,s.jsx)(n.code,{children:"second"})}),(0,s.jsx)(n.th,{style:{textAlign:"center"},children:(0,s.jsx)(n.code,{children:"minute"})}),(0,s.jsx)(n.th,{style:{textAlign:"center"},children:(0,s.jsx)(n.code,{children:"hour"})}),(0,s.jsx)(n.th,{style:{textAlign:"center"},children:(0,s.jsx)(n.code,{children:"day"})}),(0,s.jsx)(n.th,{style:{textAlign:"center"},children:(0,s.jsx)(n.code,{children:"day_of_week"})}),(0,s.jsx)(n.th,{style:{textAlign:"center"},children:(0,s.jsx)(n.code,{children:"week"})}),(0,s.jsx)(n.th,{style:{textAlign:"center"},children:(0,s.jsx)(n.code,{children:"month"})})]})}),(0,s.jsx)(n.tbody,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u65f6\u95f4\u70b9"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u79d2(0-59)"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u5206\u949f(0-59)"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u5c0f\u65f6(0-23)"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u5929(1-31)"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u6bcf\u5468(0-6)"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u5468(1-53)"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u6708(1-12)"})]})})]}),"\n",(0,s.jsx)(n.p,{children:"\u8bbe\u7f6e\u56fa\u5b9a\u65f6\u95f4\u70b9\u89e6\u53d1"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-py",children:'from datetime import datetime\n\ntimestamp = datetime.strptime("12:30:00", "%H:%M:%S")\nschedule.add_job(\n  function, \n  \'cron\', \n  hours=timestamp.hour,\n  minute=timestamp.minute\n  secondes=timestamp.second\n)\n'})}),"\n",(0,s.jsx)(n.p,{children:"\u8bbe\u7f6e\u65f6\u95f4\u95f4\u9694\u89e6\u53d1"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"start1-end1/step1, start2-end2/step2"}),(0,s.jsx)(n.br,{}),"\n","\u4ece ",(0,s.jsx)(n.code,{children:"start"})," \u5f00\u59cb\u5230 ",(0,s.jsx)(n.code,{children:"end"})," \u7ed3\u675f, \u6bcf\u9694 ",(0,s.jsx)(n.code,{children:"step"})," \u89e6\u53d1\u4e00\u6b21, \u4f7f\u7528 ",(0,s.jsx)(n.code,{children:","})," \u5206\u9694\u591a\u4e2a\u8868\u8fbe\u5f0f"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-py",children:"schedule.add_job(func, 'cron', minute='*/5')     # \u4efb\u610f\u65f6\u95f4, \u6bcf\u9694 5 \u5206\u949f\u89e6\u53d1\u4e00\u6b21\nschedule.add_job(func, 'cron', hour='1-6/2')     # 1 \u70b9\u81f3 6 \u70b9, \u6bcf\u9694 2 \u5c0f\u65f6\u89e6\u53d1\u4e00\u6b21\nschedule.add_job(func, 'cron', day='1, 4, 6')    # \u6bcf\u4e2a\u6708 1, 4, 6 \u53f7\u89e6\u53d1\u4e00\u6b21\n"})}),"\n",(0,s.jsx)(n.h2,{id:"interval-\u89e6\u53d1\u5668",children:"interval \u89e6\u53d1\u5668"}),"\n",(0,s.jsx)(n.p,{children:"interval \u8bbe\u7f6e\u65f6\u95f4\u95f4\u9694\u89e6\u53d1"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{style:{textAlign:"center"},children:"\u53c2\u6570"}),(0,s.jsx)(n.th,{style:{textAlign:"center"},children:(0,s.jsx)(n.code,{children:"seconds"})}),(0,s.jsx)(n.th,{style:{textAlign:"center"},children:(0,s.jsx)(n.code,{children:"minutes"})}),(0,s.jsx)(n.th,{style:{textAlign:"center"},children:(0,s.jsx)(n.code,{children:"hours"})}),(0,s.jsx)(n.th,{style:{textAlign:"center"},children:(0,s.jsx)(n.code,{children:"days"})}),(0,s.jsx)(n.th,{style:{textAlign:"center"},children:(0,s.jsx)(n.code,{children:"weeks"})}),(0,s.jsx)(n.th,{style:{textAlign:"center"},children:(0,s.jsx)(n.code,{children:"months"})})]})}),(0,s.jsx)(n.tbody,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u95f4\u9694"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u79d2"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u5206\u949f"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u5c0f\u65f6"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u5929"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u5468"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u6708"})]})})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-py",children:"from datetime import datetime\n\ntimestamp = datetime.strptime(\"00:00:10\", \"%H:%M:%S\")\nschedule.add_job(\n  function, \n  'interval', \n  hours=timestamp.hour,\n  minute=timestamp.minute\n  secondes=timestamp.second\n)\n\nschedule.add_job(func, 'interval', seconds=5)\nschedule.add_job(func, 'interval', minute=5)\nschedule.add_job(func, 'interval', hour=5)\nschedule.add_job(func, 'interval', day=5)\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u6ce8: \u65f6\u95f4\u95f4\u9694\u4e0e\u65f6\u95f4\u70b9\u6709\u5bf9\u5e94\u5173\u7cfb, \u6240\u4ee5\u7528\u65f6\u95f4\u70b9\u5b57\u7b26\u4e32\u8f6c\u5316\u4e3a\u65f6\u95f4\u95f4\u9694"}),"\n",(0,s.jsx)(n.h2,{id:"date-\u89e6\u53d1\u5668",children:"date \u89e6\u53d1\u5668"}),"\n",(0,s.jsx)(n.p,{children:"date \u8bbe\u7f6e\u4e00\u4e2a\u65f6\u95f4\u70b9\u53ea\u6267\u884c\u4e00\u6b21"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{style:{textAlign:"center"},children:"\u53c2\u6570"}),(0,s.jsx)(n.th,{style:{textAlign:"center"},children:(0,s.jsx)(n.code,{children:"second"})}),(0,s.jsx)(n.th,{style:{textAlign:"center"},children:(0,s.jsx)(n.code,{children:"minute"})}),(0,s.jsx)(n.th,{style:{textAlign:"center"},children:(0,s.jsx)(n.code,{children:"hour"})}),(0,s.jsx)(n.th,{style:{textAlign:"center"},children:(0,s.jsx)(n.code,{children:"day"})}),(0,s.jsx)(n.th,{style:{textAlign:"center"},children:(0,s.jsx)(n.code,{children:"week"})}),(0,s.jsx)(n.th,{style:{textAlign:"center"},children:(0,s.jsx)(n.code,{children:"month"})})]})}),(0,s.jsx)(n.tbody,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u65f6\u95f4\u70b9"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u79d2(0-59)"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u5206\u949f(0-59)"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u5c0f\u65f6(0-23)"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u5929(1-31)"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u5468(1-53)"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u6708(1-12)"})]})})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-py",children:"schedule.add_job(func, 'date', run_date='2024-01-08 10:30:00')\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u4efb\u52a1\u5b58\u50a8",children:"\u4efb\u52a1\u5b58\u50a8"}),"\n",(0,s.jsx)(n.p,{children:"\u521b\u5efa\u8c03\u5ea6\u5668\u65f6\u53ef\u4ee5\u6dfb\u52a0\u6570\u636e\u5e93\u5b58\u50a8\u4efb\u52a1"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-py",children:"from apscheduler.schedulers.blocking import BlockingScheduler\nfrom apscheduler.jobstores.mongodb import MongoDBJobStore\nfrom pymongo import MongoClient\n\n\nmongo = MongoDBJobStore(                         # \u8bbe\u7f6e monogo \u5b58\u50a8\u4efb\u52a1\n  database='db', \n  collection='collection', \n  client=MongoClient(\"mongodb://localhost:27017\")\n)\n\nschedule = BackgroundScheduler(                  # \u4f7f\u7528\u540e\u53f0\u8c03\u5ea6\n  jobstores={'default': mongo},                  # \u4f7f\u7528 mongo \u4f5c\u4e3a\u9ed8\u8ba4\u5b58\u50a8\n)\n\nscheduler.start()\n"})}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{style:{textAlign:"center"},children:"\u5b57\u6bb5"}),(0,s.jsx)(n.th,{style:{textAlign:"center"},children:(0,s.jsx)(n.code,{children:"_id"})}),(0,s.jsx)(n.th,{style:{textAlign:"center"},children:(0,s.jsx)(n.code,{children:"next_run_time"})}),(0,s.jsx)(n.th,{style:{textAlign:"center"},children:(0,s.jsx)(n.code,{children:"job_state"})})]})}),(0,s.jsx)(n.tbody,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"\u542b\u4e49"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"job.id"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"job.next_run_time"}),(0,s.jsx)(n.td,{style:{textAlign:"center"},children:"job\u72b6\u6001"})]})})]}),"\n",(0,s.jsx)(n.h2,{id:"\u4efb\u52a1\u8c03\u5ea6",children:"\u4efb\u52a1\u8c03\u5ea6"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-py",children:"\nfrom apscheduler.schedulers.background import BackgroundScheduler\n\ndef func():\n    print(f'Hello, world!')\n\nschedule = BackgroundScheduler()  \njob = scheduler.add_job(func, 'interval', seconds=2, id=\"test\")\n\njob.pause('test')\njob.resume('test')\njob.remove('test')\n\nscheduler.pause_job('test')\nscheduler.resume_job('test')\nscheduler.remove_job('test')\n\njobs = scheduler.get_jobs()\n"})}),"\n",(0,s.jsx)(n.p,{children:"job \u5c5e\u6027\nid\nname\nfunc\nargs\nnext_run_time"}),"\n",(0,s.jsx)(n.h2,{id:"\u793a\u4f8b",children:"\u793a\u4f8b"}),"\n",(0,s.jsx)(n.p,{children:"\u4f7f\u7528\u5185\u5b58\u4f5c\u5b58\u50a8\u5b9a\u65f6\u4efb\u52a1, \u670d\u52a1\u5173\u95ed\u4efb\u52a1\u4e22\u5931(\u53ef\u4ee5\u8bbe\u5b9a\u6570\u636e\u5e93\u5b58\u50a8)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-py",children:"from time import sleep\nfrom pytz import timezone\nfrom datetime import datetime, timedelta\n\nfrom loguru import logger\nfrom apscheduler.schedulers.background import BackgroundScheduler\nfrom apscheduler.jobstores.memory import MemoryJobStore\nfrom apscheduler.executors.pool import ThreadPoolExecutor, ProcessPoolExecutor\nfrom apscheduler.triggers.cron import CronTrigger\nfrom apscheduler.job import Job\n\n\nclass Schedule:\n    \n    scheduler: BackgroundScheduler | None = None\n    jobstores = {\n        # 'default': SQLAlchemyJobStore(url='sqlite:///jobs.sqlite')\n        'default': MemoryJobStore()\n    }\n    executors = {\n        'default': ThreadPoolExecutor(20),\n        'processpool': ProcessPoolExecutor(5)\n    }\n    job_defaults = {\n        'coalesce': False,\n        'max_instances': 3\n    }\n    \n    @classmethod\n    def init(cls):\n        cls.scheduler = BackgroundScheduler(\n            jobstores=cls.jobstores,\n            executors=cls.executors,\n            job_defaults=cls.job_defaults,\n            timezone=timezone(\"Asia/Shanghai\")\n        )\n        cls.scheduler.start()\n    \n    @classmethod\n    def get_jobs(cls):\n        return cls.scheduler.get_jobs()\n    \n    @classmethod\n    def add_once_job(cls, id: str, func: callable, timestamp: datetime):\n        job = cls.scheduler.add_job(func, 'date', run_date=timestamp, id=id)\n        \n    @classmethod\n    def add_cron_job(cls, id: str, func: callable, cron: str):\n        job = cls.scheduler.add_job(func, trigger=CronTrigger.from_crontab(cron), id=id)\n        \n    @classmethod\n    def remove_job(cls, id: str):\n        job = cls.scheduler.remove_job(id)\n        \n    @classmethod\n    def parse_job(cls, job: Job):\n        return {\"id\": job.id, \"job\": job.func.__name__, \"next\": job.next_run_time}\n\n# \u81ea\u5b9a\u4e49\u51fd\u6570, \u4f7f\u7528 add_once_job \u6dfb\u52a0\u4efb\u52a1\nonce_task = lambda: print(f\"task run at {datetime.now()}\")\nonce_task.__name__ = f\"run once_task at {datetime.now()}\"\nSchedule.add_once_job(id=\"once_task\", func=once_task, timestamp=datetime.now() + timedelta(hours=3))\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u5b9e\u73b0\u4e00\u4e2a\u5b9a\u65f6\u4efb\u52a1\u8c03\u5ea6\u5668, mongo \u5b58\u50a8\u4efb\u52a1"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-py",children:"from apscheduler.schedulers.background import BackgroundScheduler\nfrom apscheduler.jobstores.mongodb import MongoDBJobStore\n\n\nmongo = MongoClient(\"mongodb://localhost:27017\")\ndb = mongo['database']\nTask_Info = db['tasks']\n\nclass Schedules:\n    \"\"\" \u5b9a\u65f6\u4efb\u52a1\u7ba1\u7406 \"\"\"\n    \n    scheduler = None\n    jobstores = {\n        'default': MongoDBJobStore(\n            database='database',\n            collection='tasks',\n            client=mongo,\n        )\n    }\n    executors = {\n        'default': ThreadPoolExecutor(20),\n        'processpool': ProcessPoolExecutor(5)\n    }\n    job_defaults = {\n        'coalesce': False,\n        'max_instances': 3\n    }\n    \n    @classmethod\n    def init(cls):\n        \"\"\" \u4efb\u52a1\u7ba1\u7406\u521d\u59cb\u5316 \"\"\"\n        cls.scheduler = BackgroundScheduler(\n            jobstores=cls.jobstores,\n            executors=cls.executors,\n            job_defaults=cls.job_defaults,\n        )\n        cls.scheduler.start()\n        \n    @classmethod\n    def add_cron_job(cls, id, func, cron_str, params=None):\n        \"\"\" \u6267\u884c\u6bcf\u5929\u5468\u671f\u6027\u4efb\u52a1 \"\"\"\n        cron = datetime.strptime(cron_str, \"%H:%M:%S\")\n        params = None if params is None else [*params]\n        job = cls.scheduler.add_job(\n            func,\n            'cron', \n            id=id,\n            args=params,\n            hour=cron.hour,\n            minute=cron.minute,\n            second=cron.second,\n            coalesce=True,\n            replace_existing=True\n        )\n\n        if Task_Info.find_one({'id': id}) is not None:\n            return f\"task {id} already exist\"\n\n        Task_Info.insert_one({\n            'id': job.id,\n            'function': f\"{func.__name__}{job.args}\",\n            'type': 'cron',\n            'time': cron_str,\n            'enable': True,\n            'description': f\"{func.__name__}{job.args} with {cron_str}\",\n            'start': datetime.now().isoformat(),\n        })\n        \n        task = Task_Info.find_one({'id': job.id})\n        task.pop('_id')\n        return task\n\n    @classmethod\n    def add_interval_job(cls, id, func, interval_str, params=None):\n        \"\"\" \u6267\u884c\u5faa\u73af\u4efb\u52a1 \"\"\"\n        interval = datetime.strptime(interval_str, \"%H:%M:%S\")\n        params = None if params is None else [*params]\n        job = cls.scheduler.add_job(\n            func,\n            'interval', \n            id=id,\n            args=params,\n            hours=interval.hour,\n            minutes=interval.minute,\n            seconds=interval.second,\n            coalesce=True,\n            replace_existing=True\n        )\n        \n        if Task_Info.find_one({'id': id}) is not None:\n            return f\"task {id} already exist\"\n        \n        Task_Info.insert_one({\n            'id': id,\n            'function': f\"{func.__name__}{job.args}\",\n            'type': 'interval',\n            'time': interval_str,\n            'enable': True,\n            'description': f\"{func.__name__}{job.args} with {interval_str}\",\n            'start': datetime.now().isoformat(),\n        })\n        \n        if Task_Info.find_one({'id': id}) is None:\n            return \"task already exist\"\n\n        task = Task_Info.find_one({'id': job.id})\n        task.pop('_id')\n        return task\n        \n    @classmethod\n    def get_job(cls, job_id):\n        \"\"\" \u83b7\u53d6\u4efb\u52a1\u4fe1\u606f \"\"\"\n        return str(cls.scheduler.get_job(job_id))\n\n    @classmethod\n    def list_jobs(cls):\n        \"\"\" \u5217\u51fa\u6240\u6709\u4efb\u52a1 \"\"\"\n        status = []\n        for job in cls.scheduler.get_jobs():\n            task = Task_Info.find_one({'id': job.id})\n            task.pop('_id')\n            status.append({\n                **task,\n                'next': job.next_run_time,\n            })\n        return status\n\n    @classmethod\n    def delete_job(cls, job_id):\n        \"\"\" \u5220\u9664\u5b9a\u65f6\u4efb\u52a1 \"\"\"\n        cls.scheduler.remove_job(job_id)\n        Task_Info.delete_one({'name': job_id})\n\n    @classmethod\n    def pause_job(cls, job_id):\n        \"\"\" \u6682\u505c\u5b9a\u65f6\u4efb\u52a1 \"\"\"\n        cls.scheduler.pause_job(job_id)\n        Task_Info.update_one({'name': job_id}, {'$set': {'enable': False}})\n\n\n    @classmethod\n    def resume_job(cls, job_id):\n        \"\"\" \u6062\u590d\u5b9a\u65f6\u4efb\u52a1 \"\"\"\n        cls.scheduler.resume_job(job_id)\n        Task_Info.update_one({'name': job_id}, {'$set': {'enable': True}})\n"})})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(a,{...e})}):a(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>d,x:()=>c});var s=t(6540);const r={},l=s.createContext(r);function d(e){const n=s.useContext(l);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:d(e.components),s.createElement(l.Provider,{value:n},e.children)}}}]);