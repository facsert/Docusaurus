"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[5622],{8759:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>d,frontMatter:()=>s,metadata:()=>i,toc:()=>c});var a=t(4848),r=t(8453);const s={author:"facsert",pubDatetime:new Date("2023-10-28T14:52:02.000Z"),title:"Python fastapi",slug:"Python fastapi",featured:!1,draft:!1,tags:["Python","fastapi"],description:"Python Web \u6846\u67b6 fastapi"},o=void 0,i={id:"Python/python-fastapi",title:"Python fastapi",description:"Python Web \u6846\u67b6 fastapi",source:"@site/docs/Python/python-fastapi.md",sourceDirName:"Python",slug:"/Python/Python fastapi",permalink:"/docs/Python/Python fastapi",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Python/python-fastapi.md",tags:[{inline:!0,label:"Python",permalink:"/docs/tags/python"},{inline:!0,label:"fastapi",permalink:"/docs/tags/fastapi"}],version:"current",frontMatter:{author:"facsert",pubDatetime:"2023-10-28T14:52:02.000Z",title:"Python fastapi",slug:"Python fastapi",featured:!1,draft:!1,tags:["Python","fastapi"],description:"Python Web \u6846\u67b6 fastapi"},sidebar:"tutorialSidebar",previous:{title:"Python datetime",permalink:"/docs/Python/Python datetime"},next:{title:"Python flat dictionary",permalink:"/docs/Python/Python flat dictionary"}},l={},c=[{value:"Table of Contents",id:"table-of-contents",level:2},{value:"\u4ecb\u7ecd",id:"\u4ecb\u7ecd",level:2},{value:"\u5b89\u88c5",id:"\u5b89\u88c5",level:2},{value:"fastapi \u5165\u53e3",id:"fastapi-\u5165\u53e3",level:2},{value:"swagger-ui",id:"swagger-ui",level:2},{value:"database",id:"database",level:2},{value:"api \u8def\u7531",id:"api-\u8def\u7531",level:2},{value:"\u65e5\u5fd7",id:"\u65e5\u5fd7",level:2},{value:"\u4e2d\u95f4\u4ef6",id:"\u4e2d\u95f4\u4ef6",level:2}];function p(e){const n={a:"a",br:"br",code:"code",h2:"h2",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.h2,{id:"table-of-contents",children:"Table of Contents"}),"\n",(0,a.jsx)(n.h2,{id:"\u4ecb\u7ecd",children:"\u4ecb\u7ecd"}),"\n",(0,a.jsx)(n.p,{children:"FastAPI \u662f\u4e00\u4e2a\u73b0\u4ee3\u3001\u5feb\u901f\u3001\u5f00\u6e90\u7684 Web \u6846\u67b6\uff0c\u7528\u4e8e\u6784\u5efa\u9ad8\u6027\u80fd\u7684 RESTful API\u3002"}),"\n",(0,a.jsx)(n.h2,{id:"\u5b89\u88c5",children:"\u5b89\u88c5"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:' $ python -m pip install "fastapi[all]"\n\n tree .\n\u251c\u2500\u2500 config\n\u251c\u2500\u2500 lib                                          # \u5b58\u653e\u81ea\u5b9a\u4e49\u6a21\u5757(\u65e0\u53d8\u52a8\u6216\u53d8\u52a8\u5c11)\n\u2502\xa0\xa0 \u2514\u2500\u2500 common.py \n\u251c\u2500\u2500 LICENSE\n\u251c\u2500\u2500 log                                          # \u5b58\u653e\u65e5\u5fd7\u6587\u4ef6\n\u251c\u2500\u2500 temp                                         # \u5b58\u653e\u4e34\u65f6\u6587\u4ef6\n\u251c\u2500\u2500 static                                       # \u9759\u6001\u6587\u4ef6\n\u251c\u2500\u2500 .gitignore                                   # git \u5ffd\u7565\u6587\u4ef6\n\u251c\u2500\u2500 main.py                                      # \u542f\u52a8\u6587\u4ef6\n\u251c\u2500\u2500 README.md \n\u251c\u2500\u2500 requirement.txt                              # \u9879\u76ee\u4f9d\u8d56\u5305\n\u251c\u2500\u2500 api                                          # api \u8def\u7531\n\u2502\xa0\xa0 \u2514\u2500\u2500 v1\n\u2502       \u2514\u2500\u2500 node.py \n\u2514\u2500\u2500 utils                                        # \u81ea\u5b9a\u4e49\u6a21\u5757\n    \u251c\u2500\u2500 database.py                              # \u6570\u636e\u5e93\u8fde\u63a5\n    \u251c\u2500\u2500 logger.py                                # logger \u521d\u59cb\u5316\n    \u251c\u2500\u2500 middleware.py                            # \u4e2d\u95f4\u4ef6\n    \u251c\u2500\u2500 router.py                                # \u8def\u7531\u914d\u7f6e\n    \u2514\u2500\u2500 schemas.py                               # fastapi \u53c2\u6570\u6a21\u578b\n'})}),"\n",(0,a.jsx)(n.h2,{id:"fastapi-\u5165\u53e3",children:"fastapi \u5165\u53e3"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-py",children:'from contextlib import asynccontextmanager\n\nimport uvicorn\nfrom loguru import logger\nfrom fastapi import FastAPI\n\nfrom utils.logger import logger_setting\nfrom utils.router import add_routers\nfrom utils.database import Database\nfrom utils.middleware import add_middlewares\n\nHOST = "localhost"\nPORT = 8010\n\n@asynccontextmanager\nasync def lifespan(router: FastAPI):\n    """ \u5e94\u7528\u5f00\u542f\u548c\u7ed3\u675f\u64cd\u4f5c """\n    logger_setting()\n    Database.init()\n    add_routers(router)\n    logger.info("app start")\n    yield\n    logger.info("app close")\n    Database.close()\n\napp = FastAPI(\n    title="FastAPI",\n    description=f"{HOST}:{PORT} api",\n    version="0.0.1",\n    lifespan=lifespan\n)\n\nadd_middlewares(app)\n\n\nif __name__ == "__main__":\n    uvicorn.run("main:app", host=HOST, port=PORT, reload=True)\n'})}),"\n",(0,a.jsxs)(n.p,{children:["\u6d4f\u89c8\u5668\u6253\u5f00 ",(0,a.jsx)(n.code,{children:"http://0.0.0.0:8010/"}),(0,a.jsx)(n.br,{}),"\n","swagger-ui ",(0,a.jsx)(n.code,{children:"http://0.0.0.0:8010/docs/"})]}),"\n",(0,a.jsx)(n.h2,{id:"swagger-ui",children:"swagger-ui"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.a,{href:"https://github.com/swagger-api/swagger-ui.git",children:"Github swagger-ui"})}),"\n",(0,a.jsxs)(n.p,{children:["\u6253\u5f00 swagger \u9875\u9762\u9700\u8981\u52a0\u8f7d\u5916\u754c CDN \u8d44\u6e90\uff0c\u53ef\u80fd\u4f1a\u975e\u5e38\u6162\uff0c\u5efa\u8bae\u4f7f\u7528\u79bb\u7ebf swagger-ui \u6587\u4ef6",(0,a.jsx)(n.br,{}),"\n","\u5728 Github \u4e0b\u8f7d\u5b98\u65b9 swagger-ui \u8d44\u6e90, \u653e\u5165\u9879\u76ee ",(0,a.jsx)(n.code,{children:"static"})," \u8def\u5f84\u4e0b, \u5728\u4ee3\u7801\u4e2d\u914d\u7f6e\u5373\u53ef"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"project\n\u251c\u2500 static\n\u2502  \u2514\u2500\u2500 swagger-ui\n\u2502      \u251c\u2500\u2500 ...\n\u2502      \u2514\u2500\u2500 README.md\n\u2514\u2500\u2500 main.py\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u5728 ",(0,a.jsx)(n.code,{children:"utils/router.py"})," \u4e2d\u6302\u8f7d swagger \u5e76\u914d\u7f6e\u53ef\u7528\u8def\u7531"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-py",children:'from fastapi import FastAPI\nfrom fastapi.staticfiles import StaticFiles\nfrom fastapi.openapi.docs import get_swagger_ui_html\n\nfrom api.v1 import student, article\nfrom lib.common import abs_dir\n\ndef add_routers(app: FastAPI):\n    """ app add router"""\n    # \u6dfb\u52a0\u8def\u7531\n    app.include_router(student.router, prefix="/api/v1", tags=["student"])\n    app.include_router(article.router, prefix="/api/v1", tags=["article"])\n    \n    # mount swagger \u9759\u6001\u6587\u4ef6\n    app.mount(\'/static\', StaticFiles(\n        directory=abs_dir("static", "swagger-ui", "dist")),\n        name="static"\n    )\n\n    # \u5b9a\u4e49 swagger \u6302\u8f7d\u8def\u7531\n    @app.get("/", include_in_schema=False)\n    async def custom_swagger_ui_html():\n        """ set local static swagger """\n        return get_swagger_ui_html(openapi_url=app.openapi_url, title=app.title)\n'})}),"\n",(0,a.jsx)(n.h2,{id:"database",children:"database"}),"\n",(0,a.jsx)(n.p,{children:"\u5b9a\u4e49\u6570\u636e\u8fde\u63a5\u548c\u4f7f\u7528"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-py",children:'from contextlib import contextmanager\nfrom dataclasses import dataclass\n\nimport psycopg\nfrom psycopg_pool import ConnectionPool\nfrom psycopg.rows import dict_row\nfrom loguru import logger\n\n\n@dataclass\nclass DBConnect:\n    """ \u6570\u636e\u5e93\u8fde\u63a5 """\n    host: str\n    port: int\n    dbname: str\n    user: str\n    password: str\n\nDEFAULT_DATABASE: DBConnect = DBConnect(\n    host="localhost",\n    port="5432",\n    dbname="learn",\n    user="postgres",\n    password="password"\n)\n\nclass Database:\n    """ database module """\n    pool: ConnectionPool| None = None\n    db: DBConnect = DEFAULT_DATABASE\n\n    @classmethod\n    def init(cls, db: DBConnect|None=None) -> None:\n        """ \u6570\u636e\u5e93\u521d\u59cb\u5316\u8fde\u63a5 """\n        cls.db = db if db else cls.db\n        cls.pool: ConnectionPool = ConnectionPool(\n            min_size=1,\n            max_size=10,\n            conninfo=" ".join(f"{k}={v}" for k, v in vars(cls.db).items())\n        )\n\n    @contextmanager\n    def __new__(cls, db: DBConnect|None=None):\n        _ = cls.init(db) if db else None\n        try:\n            conn = cls.pool.getconn()\n            cursor = conn.cursor(row_factory=dict_row)\n            yield cursor\n            conn.commit()\n        except Exception as e:\n            _ = conn.rollback() if conn else None\n            logger.error(f"error: {e}")\n        finally:\n            _ = cursor.close() if cursor else None\n            _ = cls.pool.putconn(conn) if cls.pool else None\n\n\nif __name__ == "__main__":\n    # \u8d77\u670d\u52a1\u65f6\u8fde\u63a5\u6570\u636e\u5e93\n    Database.init()\n    # \u4f7f\u7528\u8fde\u63a5\u6c60\u6267\u884c sql \u8bed\u53e5\n    with Database() as cursor:\n        cursor.execute("SELECT id, title FROM article")\n        print(cursor.fetchall())\n'})}),"\n",(0,a.jsx)(n.h2,{id:"api-\u8def\u7531",children:"api \u8def\u7531"}),"\n",(0,a.jsx)(n.p,{children:"\u5b9a\u4e49 fastapi api \u8def\u7531"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-py",children:'from fastapi import APIRouter, Depends\nfrom loguru import logger\nfrom psycopg import Cursor\n\nfrom utils.database import Database\nfrom utils.schemas import Student\n\nrouter = APIRouter()\ncreated = Database.create_session\n\n@router.get("/articles")\ndef get_articles(session: Cursor = Depends(created)):\n    return session.execute("SELECT * FROM article").fetchall()\n\n@router.get("/articles/{id}")\ndef get_article(id: int, session: Cursor = Depends(created)):\n    return session.execute("SELECT * FROM article WHERE id = %s", (id,)).fetchone()\n'})}),"\n",(0,a.jsx)(n.h2,{id:"\u65e5\u5fd7",children:"\u65e5\u5fd7"}),"\n",(0,a.jsx)(n.p,{children:"\u8bbe\u7f6e\u65e5\u5fd7\u6253\u5370\u683c\u5f0f, \u8f93\u51fa\u5230\u6307\u5b9a\u6587\u4ef6"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-py",children:"from loguru import logger\n\nfrom lib.common import abs_dir\n\ndef logger_setting():\n    \"\"\" \u8bbe\u7f6e logger \"\"\"\n    logger.remove()\n\n    fmt = '[<level>{level: <8}</level>][<green>{time:YYYY-MM-DD HH:mm:ss}</green>]: <level>{message}</level>'\n    logger.add(sys.stderr,  level='INFO', format=fmt)\n    logger.add(abs_dir('log', 'report.log'),\n        level='INFO', format=fmt, rotation='1 week', retention='30 days'\n    )\n"})}),"\n",(0,a.jsx)(n.h2,{id:"\u4e2d\u95f4\u4ef6",children:"\u4e2d\u95f4\u4ef6"}),"\n",(0,a.jsx)(n.p,{children:"\u81ea\u5b9a\u4e49\u8bf7\u6c42\u5f00\u59cb\u548c\u8bf7\u6c42\u7ed3\u675f\u540e\u7684\u64cd\u4f5c"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-py",children:'from traceback import format_exc\n\nfrom fastapi.middleware.cors import CORSMiddleware\nfrom fastapi import FastAPI, Request\nfrom fastapi.responses import JSONResponse\nfrom loguru import logger\n\n\ndef add_middlewares(app: FastAPI):\n    """ \u5141\u8bb8\u6240\u6709\u8bf7\u6c42 """\n    app.add_middleware(\n        CORSMiddleware,\n        allow_origins=["*"],\n        allow_credentials=True,\n        allow_methods=["*"],\n        allow_headers=["*"],\n    )\n    \n    @app.middleware("http")\n    async def catch_exceptions(request: Request, call_next):\n        """ \u6355\u83b7\u6240\u6709\u63a5\u53e3\u6267\u884c\u5f02\u5e38 """\n        try:\n            response = await call_next(request)\n            return response\n        except Exception as e:\n            logger.error(format_exc())\n            return JSONResponse(status_code=500, content={"message": "Server run error"})\n'})})]})}function d(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(p,{...e})}):p(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>i});var a=t(6540);const r={},s=a.createContext(r);function o(e){const n=a.useContext(s);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),a.createElement(s.Provider,{value:n},e.children)}}}]);